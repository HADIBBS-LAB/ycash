// Copyright (c) 2016 The Zcash developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or http://www.opensource.org/licenses/mit-license.php.

#include "uint256.h"

#include <atomic>
#include <mutex>
#include <string>

struct AtomicCounter {
    std::atomic<uint64_t> value;

    AtomicCounter() : value {0} { }

    void increment(){
        ++value;
    }

    void decrement(){
        --value;
    }

    int get() const {
        return value.load();
    }
};

class AtomicTimer {
private:
    std::mutex mtx;
    uint64_t threads;
    int64_t start_time;
    int64_t total_time;

public:
    AtomicTimer() : threads(0), start_time(0), total_time(0) {}

    /**
     * Starts timing on first call, and counts the number of calls.
     */
    void start();

    /**
     * Counts number of calls, and stops timing after it has been called as
     * many times as start().
     */
    void stop();

    bool running();

    uint64_t threadCount();

    double rate(const AtomicCounter& count);
};

extern AtomicCounter transactionsValidated;
extern AtomicCounter ehSolverRuns;
extern AtomicCounter solutionTargetChecks;
extern AtomicTimer miningTimer;

void TrackMinedBlock(uint256 hash);

void MarkStartTime();
double GetLocalSolPS();
int EstimateNetHeightInner(int height, int64_t tipmediantime,
                           int heightLastCheckpoint, int64_t timeLastCheckpoint,
                           int64_t genesisTime, int64_t targetSpacing);

void TriggerRefresh();

void ConnectMetricsScreen();
void ThreadShowMetricsScreen();

/**
 *
 * Rendering options:
 * Ycash: img2txt -W 60 -H 30 -f utf8 -d none -g 0.7 ycash.png > ycash.txt
 */
const std::string METRICS_ART = " \n"                                                            
"                           [0;1;30;90;47m8.[0;1;37;97;47mX[0;37;5;47;107m@;       :X[0;1;37;97;47m@ [0;1;30;90;47m8[0m                \n"
"                      [0;1;30;90;47mX[0;1;37;97;47mX[0;37;5;47;107m:     .S[0;1;37;97;47m8S;:.:%@[0;37;5;47;107mX.    @[0;1;30;90;47m%[0m            \n"
"                   [0;1;37;97;47m;[0;37;5;47;107m:    @[0;1;30;90;47m.[0m                 [0;1;30;90;47mS[0;1;37;97;47m8[0;37;5;47;107m   8[0m          \n"
"                [0;1;30;90;47m:[0;37;5;47;107m;   .[0;1;37;97;47m;[0m                        [0;1;30;90;47mS[0;37;5;47;107m:  [0;1;37;97;47mt[0m        \n"
"              [0;1;37;97;47m%[0;37;5;47;107m    8[0m    [0;37;5;47;107m:.    .[0m       [0;1;30;90;47m%[0;37;5;47;107m..    :[0m   [0;1;37;97;47m@[0;37;5;47;107m  8[0m       \n"
"            [0;1;37;97;47m [0;37;5;47;107m    [0;1;37;97;47mX[0m        [0;37;5;47;107m;   [0;1;37;97;47m [0m          [0;37;5;47;107m   .[0m     [0;37;5;47;107m@  [0;1;37;97;47m [0m      \n"
"           [0;37;5;47;107mt   8[0m         [0;37;5;47;107m8   [0;1;37;97;47mt[0m          [0;37;5;47;107m:   [0m       [0;37;5;47;107m  .[0m      \n"
"         [0;1;30;90;47m@[0;37;5;47;107m   .[0;1;30;90;47m8[0m         [0;1;37;97;47m8[0;37;5;47;107m   [0;1;37;97;47mX[0m          [0;37;5;47;107m;   [0m        [0;37;5;47;107m   [0m      \n"
"        [0;1;30;90;47m%[0;37;5;47;107m   t[0m          [0;1;37;97;47mS[0;37;5;47;107m   [0;1;37;97;47m8[0m          [0;37;5;47;107m;   [0;1;30;90;47m@[0m       [0;1;30;90;47m8[0;37;5;47;107m  :[0m      \n"
"        [0;37;5;47;107m   ;[0m          [0;1;37;97;47m;[0;37;5;47;107m   @[0m          [0;37;5;47;107mt   [0;1;30;90;47mt[0m        [0;37;5;47;107m%  [0;1;30;90;47m%[0m      \n"
"       [0;37;5;47;107m:   [0m          [0;1;30;90;47m.[0;37;5;47;107m   %[0m          [0;37;5;47;107m;   [0;1;30;90;47m [0m        [0;1;37;97;47m8[0;37;5;47;107m  [0;1;37;97;47mS[0m       \n"
"      [0;1;30;90;47m;[0;37;5;47;107m   [0;1;37;97;47m8[0m          [0;37;5;47;107m    [0m         [0;1;30;90;47mX[0;37;5;47;107m.   [0;1;37;97;47m;[0m        [0;37;5;47;107m% :[0;1;30;90;47m@[0m        \n"
"      [0;37;5;47;107m;   [0m          [0;37;5;47;107mt   8[0m        [0;37;5;47;107mX    [0;1;37;97;47mS[0m       [0;37;5;47;107m8 ;[0;1;30;90;47m%[0m          \n"
"      [0;37;5;47;107m    [0m          [0;37;5;47;107m.   ;[0m     [0;1;30;90;47m%[0;37;5;47;107m%     [0;1;37;97;47m8[0m     [0;1;37;97;47m;[0;37;5;47;107m:;[0;1;37;97;47m.[0m             \n"
"      [0;37;5;47;107m    [0m          [0;1;30;90;47m8[0;37;5;47;107m.    .. .[0;1;37;97;47mX[0m [0;37;5;47;107m8   :[0;1;30;90;47m8t[0;1;37;97;47mX[0;37;5;47;107m;X[0;1;37;97;47m:[0m                 \n"
"      [0;37;5;47;107m    [0m             [0;1;30;90;47m;[0;1;37;97;47m:;[0;1;30;90;47m.8[0m   [0;1;37;97;47m:[0;37;5;47;107m    X8[0m                      \n"
"      [0;37;5;47;107m;   [0m                [0;1;30;90;47m.[0;1;37;97;47m8[0;37;5;47;107mt@.   8[0m              [0;1;30;90;47m8[0;37;5;47;107m. [0;1;37;97;47m8[0m       \n"
"      [0;1;30;90;47m:[0;37;5;47;107m   [0;1;37;97;47m;[0m          [0;1;30;90;47m;[0;37;5;47;107m8.[0;1;37;97;47mX[0;1;30;90;47m@[0m   [0;1;30;90;47mt[0;37;5;47;107m   [0;1;37;97;47m@[0m               [0;37;5;47;107m   [0m        \n"
"       [0;37;5;47;107m.   [0m       [0;1;30;90;47m8[0;37;5;47;107mt [0;1;37;97;47m%[0m      [0;1;37;97;47m:[0;37;5;47;107m   [0;1;30;90;47m:[0m              [0;1;30;90;47m@[0;37;5;47;107m   [0;1;30;90;47m%[0m        \n"
"        [0;37;5;47;107m   ;[0m     [0;37;5;47;107m8 X[0m       [0;37;5;47;107m@  %[0m               [0;1;37;97;47m%[0;37;5;47;107m  .[0;1;30;90;47m8[0m         \n"
"        [0;1;30;90;47mt[0;37;5;47;107m   :[0m    [0;37;5;47;107m  [0m      [0;1;37;97;47mt[0;37;5;47;107m  ;[0;1;30;90;47m@[0m               [0;37;5;47;107m;  %[0m           \n"
"          [0;37;5;47;107m.   [0;1;37;97;47m@[0m  [0;1;37;97;47m%[0;37;5;47;107m  8[0;1;37;97;47mS@[0;37;5;47;107m; .[0;1;37;97;47mS[0m                [0;37;5;47;107mS  .[0;1;30;90;47m:[0m            \n"
"           [0;1;37;97;47m@[0;37;5;47;107m    [0;1;37;97;47m8[0m                       [0;1;37;97;47m;[0;37;5;47;107m.  .[0;1;37;97;47m:[0m              \n"
"             [0;1;37;97;47mt[0;37;5;47;107m.    8[0;1;30;90;47m;[0m               [0;1;30;90;47m [0;37;5;47;107m@    %[0;1;30;90;47mS[0m                \n"
"                [0;1;37;97;47m;[0;37;5;47;107m;        :tt;.        8[0;1;30;90;47mS[0m                   \n"
"                    [0;1;30;90;47m8.[0;1;37;97;47mS[0;37;5;47;107m8t.      ;8[0;1;37;97;47mS[0;1;30;90;47m;[0m                        \n";
                                                            