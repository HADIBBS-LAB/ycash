// Copyright (c) 2016 The Zcash developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or http://www.opensource.org/licenses/mit-license.php.

#include "uint256.h"

#include <atomic>
#include <mutex>
#include <string>

struct AtomicCounter {
    std::atomic<uint64_t> value;

    AtomicCounter() : value {0} { }

    void increment(){
        ++value;
    }

    void decrement(){
        --value;
    }

    int get() const {
        return value.load();
    }
};

class AtomicTimer {
private:
    std::mutex mtx;
    uint64_t threads;
    int64_t start_time;
    int64_t total_time;

public:
    AtomicTimer() : threads(0), start_time(0), total_time(0) {}

    /**
     * Starts timing on first call, and counts the number of calls.
     */
    void start();

    /**
     * Counts number of calls, and stops timing after it has been called as
     * many times as start().
     */
    void stop();

    bool running();

    uint64_t threadCount();

    double rate(const AtomicCounter& count);
};

extern AtomicCounter transactionsValidated;
extern AtomicCounter ehSolverRuns;
extern AtomicCounter solutionTargetChecks;
extern AtomicTimer miningTimer;

void TrackMinedBlock(uint256 hash);

void MarkStartTime();
double GetLocalSolPS();
int EstimateNetHeightInner(int height, int64_t tipmediantime,
                           int heightLastCheckpoint, int64_t timeLastCheckpoint,
                           int64_t genesisTime, int64_t targetSpacing);

void TriggerRefresh();

void ConnectMetricsScreen();
void ThreadShowMetricsScreen();

/**
 * Heart image: https://commons.wikimedia.org/wiki/File:Heart_coraz%C3%B3n.svg
 * License: CC BY-SA 3.0
 *
 * Rendering options:
 * Zcash: img2txt -W 40 -H 20 -f utf8 -d none -g 0.7 Z-yellow.orange-logo.png
 * Heart: img2txt -W 40 -H 20 -f utf8 -d none 2000px-Heart_coraz√≥n.svg.png
 */
const std::string METRICS_ART = " \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@@@@@@@@@8@@@@8@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@@@@@@@@8[0;30;5;40;100m8[0;34;5;40;100mS[0;36;5;40;100mS:[0;37;5;40;100m8[0;1;30;90;47m8@@8[0;37;5;40;100m8[0;36;5;40;100m.%[0;34;5;40;100mS[0;30;5;40;100m8[0;1;30;90;40m8@@@@@@@@@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@@@@8[0;30;5;40;100m8[0;36;5;40;100m;[0;1;30;90;47m8SX8[0;37;5;40;100m@[0;35;5;40;100m .:[0;36;5;40;100m@S%;  [0;1;30;90;47m8XX8[0;36;5;40;100m;[0;34;5;40;100m@[0;1;30;90;40m8@@@@@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@88[0;36;5;40;100mt[0;1;30;90;47m%.8[0;35;5;40;100m.SX[0;1;30;90;40m8[0;1;30;90;47mS[0;35;5;40;100m8@[0;31;5;40;100mS[0;1;30;90;40m8[0;35;5;40;100m:;8@:[0;30;5;40;100m8[0;34;5;40;100mS[0;35;5;40;100m%%[0;37;5;40;100m@[0;1;30;90;47m;;[0;36;5;40;100mS[0;30;5;40;100m8[0;1;30;90;40m@@@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@XX@[0;30;5;40;100m8[0;36;5;40;100mt[0;1;30;90;47mt8[0;36;5;40;100m%[0;34;5;40;100m8[0;35;5;40;100m:[0;31;5;40;100mX[0;1;30;90;40m8@8[0;35;5;40;100mtX88[0;1;30;90;40m8[0;37;5;40;100m8[0;35;5;40;100mX8@S[0;1;30;90;40m@@[0;31;5;40;100mS[0;35;5;40;100m.8@[0;34;5;40;100mS[0;1;30;90;47m8t[0;36;5;40;100m [0;30;5;40;100m8[0;1;30;90;40m@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@8[0;36;5;40;100mS[0;1;30;90;47m;8[0;35;5;40;100mt@[0;1;30;90;40m88[0;1;30;90;47m8[0;35;5;40;100m8[0;30;5;40;100mS[0;35;5;40;100m8[0;31;5;40;100m@X[0;35;5;40;100m@88[0;31;5;40;100mS[0;35;5;40;100m8[0;30;5;40;100mX[0;1;30;90;40m8@@@8[0;1;30;90;47mS[0;31;5;40;100mS[0;1;30;90;40m8@[0;35;5;40;100m.SS[0;37;5;40;100mS[0;1;30;90;47m:[0;36;5;40;100m.[0;30;5;40;100m8[0;1;30;90;40m@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@[0;30;5;40;100m8[0;1;30;90;47m@.[0;36;5;40;100m%[0;1;30;90;47mX[0;30;5;40;100m@[0;32;40mS[0;1;30;90;40m8[0;35;5;40;100m8[0;30;5;40;100m8[0;31;5;40;100mSSX[0;35;5;40;100mXSSSXSXXXXSS[0;31;5;40;100m@[0;30;5;40;100m8[0;1;30;90;40m8@[0;35;5;40;100m;8X[0;31;5;40;100mS[0;35;5;40;100m8[0;34;5;40;100mS[0;1;30;90;47m@%[0;30;5;40;100m@[0;1;30;90;40m8@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@[0;30;5;40;100mX[0;1;30;90;47m%[0;37;5;40;100m8[0;34;5;40;100m8[0;1;30;90;40m8[0;35;5;40;100m..X8@[0;30;5;40;100m@[0;35;5;40;100mSXX[0;30;5;40;100m8[0;1;30;90;40m@@@@@@@@@@[0;30;5;40;100m8[0;35;5;40;100mXXX[0;30;5;40;100m@[0;35;5;40;100mX8[0;31;5;40;100mS[0;35;5;40;100m8[0;1;30;90;40m8[0;30;5;40;100mX[0;35;5;40;100m [0;36;5;40;100m [0;1;30;90;47m.[0;36;5;40;100mX[0;1;30;90;40m8@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@8[0;34;5;40;100m@[0;1;30;90;47mt8[0;37;5;40;100m88[0;35;5;40;100m@%[0;31;5;40;100mX[0;1;30;90;40m88[0;35;5;40;100mX%[0;30;5;40;100m8[0;1;30;90;40m@@@@@@@@@@@@@@@@[0;30;5;40;100m8[0;35;5;40;100m%@[0;30;5;40;100m8[0;35;5;40;100m8[0;1;30;90;40m8[0;35;5;40;100m [0;37;5;40;100m8[0;30;5;40;100m8[0;35;5;40;100m8[0;36;5;40;100m.[0;1;37;97;47mt[0;36;5;40;100m@[0;1;30;90;40m8@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@[0;30;5;40;100m8[0;1;30;90;47mXX[0;35;5;40;100mS[0;1;30;90;47mt[0;35;5;40;100m88[0;30;5;40;100m88X[0;35;5;40;100m%8[0;1;30;90;40m8@@@@@@@@@@@@@@@@@@8[0;31;5;40;100mS[0;35;5;40;100m%[0;30;5;40;100m@[0;1;30;90;40m8[0;35;5;40;100m@[0;30;5;40;100m8[0;1;30;90;40mX[0;35;5;40;100m@:[0;36;5;40;100m.[0;1;30;90;47m;[0;34;5;40;100m8[0;1;30;90;40m@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@8[0;36;5;40;100m;[0;1;30;90;47m [0;34;5;40;100mS[0;1;30;90;40m@[0;30;5;40;100m8[0;1;30;90;47mX[0;30;5;40;100m@[0;1;30;90;40m@8[0;35;5;40;100m;[0;1;30;90;40m8@@@@@@@@@@@@@@@@@@@@@@8[0;35;5;40;100m.[0;31;5;40;100mX[0;30;5;40;100m8[0;35;5;40;100mS:[0;1;30;90;47mS[0;31;5;40;100m@[0;30;5;40;100m8[0;1;30;90;47mt[0;36;5;40;100m [0;1;30;90;40m8@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@[0;30;5;40;100m8[0;1;30;90;47m:[0;36;5;40;100m%[0;1;30;90;40m8@@[0;30;5;40;100m8[0;1;30;90;40m88[0;35;5;40;100m:[0;30;5;40;100m@[0;1;30;90;40m@@@@@@@@@@@@@@@@@@@@@@@@[0;30;5;40;100m8[0;35;5;40;100m [0;30;5;40;100m8[0;1;30;90;40m@8@@8[0;36;5;40;100m%[0;1;37;97;47mt[0;36;5;40;100m8[0;1;30;90;40m@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@[0;36;5;40;100m@[0;1;30;90;47m [0;34;5;40;100m@[0;1;30;90;40m8[0;30;5;40;100mX8[0;1;30;90;40m@@[0;35;5;40;100mS8[0;1;30;90;40m@@8[0;30;5;40;100m@[0;1;30;90;40m8@@@@@@@@@@@@@@@@@@@@@[0;35;5;40;100m8%[0;1;30;90;40m@8@@@[0;30;5;40;100m@[0;1;30;90;47m [0;36;5;40;100m.[0;1;30;90;40m8@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@8[0;36;5;40;100m;[0;1;30;90;47m%[0;30;5;40;100m8[0;1;30;90;40m8[0;36;5;40;100m [0;1;30;90;47m:[0;36;5;40;100m8[0;1;30;90;40m8[0;35;5;40;100m [0;1;30;90;40m8@[0;30;5;40;100m8[0;36;5;40;100mt[0;1;30;90;47m.[0;34;5;40;100m@[0;1;30;90;40m@@@@@@@@@@@@@@@@@@@@@8[0;35;5;40;100m%[0;1;30;90;40m@X@@@8[0;36;5;40;100m [0;1;30;90;47m;[0;30;5;40;100m8[0;1;30;90;40m@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@[0;30;5;40;100m8[0;37;5;40;100m8[0;1;30;90;47m8[0;1;30;90;40m8@[0;30;5;40;100m8[0;37;5;40;100m8[0;1;37;97;47m:[0;36;5;40;100mt[0;35;5;40;100m;[0;1;30;90;40m8[0;30;5;40;100m8[0;36;5;40;100m [0;1;37;97;47m;[0;36;5;40;100m@[0;1;30;90;40m8[0;30;5;40;100m888[0;1;30;90;40m8@@@@88@@@8[0;30;5;40;100m8[0;34;5;40;100mXX[0;30;5;40;100m8[0;1;30;90;40m@X88[0;35;5;40;100m%[0;1;30;90;40m8X@@@8[0;36;5;40;100mt[0;1;37;97;47m;[0;30;5;40;100m8[0;1;30;90;40m@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@[0;30;5;40;100m8[0;37;5;40;100m8[0;1;30;90;47m8[0;1;30;90;40m8@@[0;30;5;40;100m8[0;36;5;40;100m.[0;1;37;97;47m.[0;36;5;40;100m@[0;34;5;40;100mX[0;36;5;40;100m [0;1;37;97;47m.[0;36;5;40;100m%S[0;1;30;90;47m%.:.;[0;36;5;40;100m%[0;1;30;90;40m8@[0;34;5;40;100mS[0;1;30;90;47mS8[0;30;5;40;100m@[0;1;30;90;40m@8[0;36;5;40;100m [0;1;30;90;47m ;: [0;36;5;40;100mX[0;1;30;90;40m8[0;36;5;40;100mS[0;37;5;40;100m8[0;35;5;40;100m.[0;1;30;90;40m8X[0;30;5;40;100m8[0;36;5;40;100mt[0;30;5;40;100m8[0;1;30;90;40m8[0;36;5;40;100m;[0;1;37;97;47m;[0;30;5;40;100m8[0;1;30;90;40m@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@8[0;36;5;40;100m:[0;1;30;90;47mS[0;30;5;40;100m8[0;1;30;90;40m@X@8[0;36;5;40;100m.[0;1;30;90;47m..X[0;36;5;40;100m8X[0;1;37;97;47m:[0;36;5;40;100mt[0;34;5;40;100m@[0;30;5;40;100m88[0;36;5;40;100mSS[0;1;30;90;40m8[0;30;5;40;100m8[0;1;30;90;47m%X:[0;37;5;40;100m8[0;30;5;40;100m8[0;34;5;40;100mX[0;1;37;97;47m;[0;36;5;40;100m%[0;34;5;40;100mX[0;30;5;40;100m8[0;36;5;40;100mt%[0;1;30;90;40m8[0;36;5;40;100m;[0;1;37;97;47m%[0;35;5;40;100m:[0;1;30;90;40m88[0;36;5;40;100mS[0;1;37;97;47m@[0;36;5;40;100mX[0;30;5;40;100m8[0;36;5;40;100m [0;1;30;90;47m.[0;30;5;40;100m8[0;1;30;90;40m@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@8[0;36;5;40;100mX[0;1;30;90;47m.[0;34;5;40;100m@[0;1;30;90;40m@@@@8[0;37;5;40;100m8[0;1;30;90;47m.[0;34;5;40;100m@[0;30;5;40;100m8[0;1;30;90;47m@8[0;30;5;40;100m8[0;1;30;90;40m@@X@@8[0;34;5;40;100mS[0;1;30;90;47mt[0;36;5;40;100mX%[0;1;37;97;47mt[0;36;5;40;100m@[0;30;5;40;100m8[0;36;5;40;100m;[0;1;30;90;47m;.;[0;36;5;40;100m 8[0;1;30;90;40m8[0;36;5;40;100mX[0;1;37;97;47m@[0;1;30;90;47m%SS[0;36;5;40;100m [0;1;37;97;47m@[0;36;5;40;100mX[0;30;5;40;100m@[0;1;30;90;47m:[0;36;5;40;100m [0;1;30;90;40m8@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@[0;30;5;40;100m@[0;1;30;90;47m.[0;36;5;40;100mS[0;1;30;90;40m8@@@[0;30;5;40;100m8[0;37;5;40;100m8[0;1;30;90;47m [0;30;5;40;100m@[0;1;30;90;40m8[0;36;5;40;100mt[0;1;30;90;47m [0;36;5;40;100m@[0;1;30;90;40m888[0;30;5;40;100m88[0;34;5;40;100mS[0;1;30;90;47m:t@8X;[0;34;5;40;100mSS[0;30;5;40;100m88[0;34;5;40;100mS[0;1;30;90;47m@[0;1;37;97;47m:[0;34;5;40;100mX[0;36;5;40;100mX[0;1;30;90;47m:[0;36;5;40;100m%SX%[0;1;37;97;47m@[0;36;5;40;100m@@[0;1;37;97;47m%[0;36;5;40;100m@[0;1;30;90;40m@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@X8[0;36;5;40;100m [0;1;30;90;47m;[0;34;5;40;100m@[0;1;30;90;40m@X@8[0;36;5;40;100m [0;1;30;90;47m.[0;35;5;40;100m;[0;1;30;90;40m8[0;30;5;40;100m8[0;36;5;40;100m [0;1;37;97;47m.[0;1;30;90;47m%[0;37;5;40;100m8[0;1;30;90;47mX [0;37;5;40;100m8[0;36;5;40;100m [0;1;37;97;47m;[0;34;5;40;100mX[0;1;30;90;40m8@[0;34;5;40;100mX[0;1;37;97;47mt[0;36;5;40;100m [0;1;30;90;47m [0;36;5;40;100m @X[0;1;30;90;47mS [0;34;5;40;100m@[0;36;5;40;100mt[0;1;37;97;47mX[0;34;5;40;100mS[0;1;30;90;40m@@[0;36;5;40;100m@[0;1;37;97;47mX[0;36;5;40;100mX[0;1;30;90;47mX[0;37;5;40;100m8[0;30;5;40;100m8[0;1;30;90;40m@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@X@[0;30;5;40;100m@[0;1;30;90;47m:[0;37;5;40;100m8[0;30;5;40;100m8[0;1;30;90;40m@@@[0;34;5;40;100mS[0;36;5;40;100m%[0;35;5;40;100m8;[0;31;5;40;100mS[0;1;30;90;40m8[0;30;5;40;100m8[0;36;5;40;100mX;%[0;34;5;40;100m@[0;30;5;40;100m8[0;36;5;40;100m:S[0;1;30;90;40m8@@8[0;36;5;40;100mS%[0;34;5;40;100mS[0;36;5;40;100m [0;1;30;90;47m88[0;36;5;40;100m [0;35;5;40;100mXS[0;34;5;40;100m8[0;36;5;40;100m:[0;1;30;90;40m8@@[0;30;5;40;100m@[0;37;5;40;100m@[0;36;5;40;100mt[0;1;30;90;47m.[0;34;5;40;100mX[0;1;30;90;40m@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@X8[0;36;5;40;100m8[0;1;37;97;47m:[0;36;5;40;100m:[0;1;30;90;40m8@X@@@8[0;35;5;40;100mXS[0;1;30;90;40m8XX@@@@@@@@@@@@@@8[0;35;5;40;100mXS[0;1;30;90;40m8@@@X@8[0;36;5;40;100mX[0;1;37;97;47mt[0;36;5;40;100m%[0;1;30;90;40m8@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@8[0;36;5;40;100m@[0;1;30;90;47m.[0;36;5;40;100m;[0;30;5;40;100m8[0;1;30;90;40m@@@@@@[0;31;5;40;100mX[0;35;5;40;100mXX@[0;1;30;90;40m8@@@@@@@@@@8[0;35;5;40;100m8SX@[0;1;30;90;40m@@X@@@8[0;36;5;40;100mt[0;1;37;97;47m:[0;36;5;40;100mt[0;1;30;90;40m8@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@[0;34;5;40;100mX[0;1;30;90;47m%%[0;34;5;40;100mS[0;1;30;90;40m8X@88[0;35;5;40;100m;[0;30;5;40;100m@[0;1;30;90;40m@[0;35;5;40;100m8XXX@@XS8X@X@8:S[0;31;5;40;100mS[0;35;5;40;100mS[0;1;30;90;40m8@@8[0;30;5;40;100m@[0;37;5;40;100m8[0;1;30;90;47mt[0;34;5;40;100mS[0;1;30;90;40m8@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@[0;30;5;40;100m8[0;36;5;40;100m;[0;1;30;90;47m [0;36;5;40;100m.[0;30;5;40;100m@[0;1;30;90;40m@[0;35;5;40;100m8;8SS[0;1;30;90;45m8[0;30;5;40;100mX[0;31;5;40;100mX[0;1;30;90;47m@[0;35;5;40;100m%t8[0;1;30;90;40m8[0;35;5;40;100m:8% [0;30;5;40;100m@[0;31;5;40;100m@[0;1;30;90;47m%[0;35;5;40;100m;;[0;31;5;40;100mXXS[0;30;5;40;100m8[0;36;5;40;100mt[0;1;30;90;47m [0;37;5;40;100m8[0;30;5;40;100m8[0;1;30;90;40m@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@8[0;34;5;40;100mX[0;37;5;40;100m8[0;1;30;90;47mt[0;36;5;40;100m [0;34;5;40;100mS[0;1;30;90;40m8@8[0;35;5;40;100m8S[0;1;30;90;40m8[0;35;5;40;100mS;S%[0;30;5;40;100mX[0;1;30;90;40m8[0;1;30;90;47m;[0;35;5;40;100m8S[0;1;30;90;47mX[0;35;5;40;100m8[0;1;30;90;40m@[0;30;5;40;100m@[0;37;5;40;100m8[0;35;5;40;100mSt.[0;36;5;40;100m [0;1;30;90;47m%@[0;34;5;40;100mS[0;1;30;90;40m8@X@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@8[0;30;5;40;100m8[0;36;5;40;100m [0;1;30;90;47m:S[0;36;5;40;100m%[0;34;5;40;100m@[0;35;5;40;100mS[0;1;30;90;40m8[0;30;5;40;100m@[0;1;30;90;47m [0;35;5;40;100m@[0;30;5;40;100mX[0;31;5;40;100m@[0;1;30;90;40m88[0;1;30;90;47m:[0;35;5;40;100m8[0;1;30;90;40m@[0;30;5;40;100m@[0;1;30;90;47m@[0;31;5;40;100mS[0;1;30;90;40m8[0;35;5;40;100mX[0;36;5;40;100m:[0;1;30;90;47m@:[0;37;5;40;100m@[0;34;5;40;100mX[0;1;30;90;40m8@@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@X@@[0;30;5;40;100m8[0;34;5;40;100mS[0;36;5;40;100m [0;1;30;90;47mSS8[0;36;5;40;100m .[0;35;5;40;100m..:S[0;1;30;90;40m8[0;31;5;40;100mS[0;1;30;90;40m8X[0;30;5;40;100m@[0;36;5;40;100m [0;1;30;90;47m@SX[0;37;5;40;100m8[0;36;5;40;100mS[0;30;5;40;100m8[0;1;30;90;40m@@@@@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@@@@@@@8[0;30;5;40;100m8X[0;36;5;40;100mt [0;1;30;90;47m@S%%[0;36;5;40;100m%[0;1;30;90;40m88@[0;30;5;40;100mX[0;36;5;40;100m;[0;34;5;40;100mX[0;30;5;40;100m8[0;1;30;90;40m8@@@@@@@@@@@@@@@@@@@@@[0m \n"
"[0;1;30;90;40m@@@@@@@@@@@@@@@@@@@@@@@@@@@888@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[0m \n";